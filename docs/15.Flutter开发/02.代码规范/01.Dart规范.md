---
title: Dart 代码规范
date: 2025-01-29 00:00:00
permalink: /develop/style/dart
categories:
  - 开发
tags:
  - 开发
  - 规范
description: 介绍 OneTJ 项目的 Dart 代码规范。
---

## 代码风格

OneTJ 遵循 [Dart 官方代码风格指南](https://dart.dev/guides/language/effective-dart/style)。

## 格式化

### 使用 dart format

```bash
# 格式化所有文件
fvm dart format .

# 格式化指定文件
fvm dart format lib/main.dart

# 检查格式（不修改文件）
fvm dart format --output=none --set-exit-if-changed .
```

### 行长度

最大行长度：**100 字符**

```dart
// lib/analysis_options.yaml
include: package:flutter_lints/flutter.yaml

linter:
  rules:
    - lines_longer_than_80_chars
```

## 命名规范

### 类型命名

使用 **大驼峰**（UpperCamelCase）：

```dart
class LoginViewModel {}
class StudentInfoData {}
enum TokenType {}
```

### 变量命名

使用 **小驼峰**（lowerCamelCase）：

```dart
var userName = '';
final isLoggedIn = false;
const maxRetries = 3;
```

### 常量命名

使用 **小驼峰**（lowerCamelCase）：

```dart
const apiBaseUrl = 'https://api.tongji.edu.cn';
const defaultTimeout = 30;
```

::: tip 说明

Dart 推荐常量也使用小驼峰，而不是大写下划线。

:::

### 私有成员

使用 **下划线前缀**：

```dart
class LoginViewModel {
  String _privateField = '';
  void _privateMethod() {}
}
```

### 文件命名

使用 **小写下划线**（snake_case）：

```
login_view_model.dart
student_info_repository.dart
app_router.dart
```

## 代码组织

### 导入顺序

```dart
// 1. Dart SDK
import 'dart:async';

// 2. Flutter 框架
import 'package:flutter/material.dart';

// 3. 第三方包
import 'package:go_router/go_router.dart';
import 'package:hive/hive.dart';

// 4. 项目内部
import 'package:onetj/app/router/app_router.dart';
import 'package:onetj/models/student_info.dart';

// 5. 相对路径
import '../models/base_model.dart';
```

### 类成员顺序

```dart
class MyClass {
  // 1. 静态常量
  static const constant = 1;

  // 2. 静态变量
  static var variable = 2;

  // 3. 实例变量
  final int finalField;
  int _privateField;

  // 4. 构造函数
  MyClass(this.finalField);

  // 5. 工厂构造函数
  factory MyClass.create() => MyClass(0);

  // 6. Getter/Setter
  int get value => _privateField;

  // 7. 公共方法
  void publicMethod() {}

  // 8. 私有方法
  void _privateMethod() {}
}
```

## 注释规范

### 文档注释

使用 `///` 表示文档注释：

```dart
/// 获取学生信息。
///
/// 返回包含学生姓名、学号等信息的 [StudentInfoData] 对象。
/// 抛出 [AppException] 当请求失败时。
Future<StudentInfoData> fetchStudentInfo() async {
  // ...
}
```

### 单行注释

使用 `//` 表示单行注释：

```dart
// 检查令牌是否过期
if (token.isExpired) {
  return;
}
```

### 块注释

使用 `/* */` 表示块注释：

```dart
/*
 * 这是一个块注释
 * 用于多行说明
 */
```

## 类型注解

### 显式类型注解

```dart
// 推荐
String name = '张三';
int age = 20;
Future<void> loadData() async {}

// 不推荐
var name = '张三';
```

### 函数返回类型

```dart
// 推荐
Future<StudentInfoData> fetchStudentInfo() async {}

// 不推荐
fetchStudentInfo() async {}
```

### 类型推断

在类型显而易见时可以省略：

```dart
// 可以省略
const users = [];
final map = <String, int>{};

// 需要注解
List<String> names = [];
Map<String, int> scores = {};
```

## 字符串

### 字符串拼接

```dart
// 推荐：使用字符串插值
final message = 'Hello, $name';
final result = '1 + 1 = ${1 + 1}';

// 多行字符串
const multiline = '''
这是一个
多行字符串
''';
```

### 避免相邻字符串字面量

```dart
// 不推荐
print('Hello' 'World');

// 推荐
print('HelloWorld');
// 或使用插值
print('$hello$world');
```

## 集合

### 集合字面量

```dart
// 推荐
const points = <int>[];
const names = <String>[];
const mapping = <String, int>{};

// 不推荐
var points = List<int>();
var names = List<String>();
```

### 集合操作

```dart
// 展开
final all = [
  ...list1,
  ...list2,
];

// if 元素
const showDiscount = true;
const items = [
  'Apple',
  if (showDiscount) 'Discount',
];

// for 元素
const numbers = [1, 2, 3];
const doubled = [
  for (var n in numbers) n * 2,
];
```

## 异步编程

### 使用 async/await

```dart
// 推荐
Future<void> loadData() async {
  final data = await api.fetchData();
  process(data);
}

// 不推荐（回调地狱）
Future<void> loadData() {
  return api.fetchData().then((data) {
    process(data);
  });
}
```

### 错误处理

```dart
try {
  final data = await riskyOperation();
} on AppException catch (e) {
  // 处理特定异常
  handleError(e.code);
} catch (e, stackTrace) {
  // 处理其他异常
  log('Unexpected error', error: e, stackTrace: stackTrace);
}
```

## 最佳实践

### 使用 const 构造函数

```dart
// 推荐
const padding = EdgeInsets.all(16);
const color = Color(0xFF000000);

// 不推荐
final padding = EdgeInsets.all(16);
final color = Color(0xFF000000);
```

### 级联调用

```dart
// 推荐
final button = ElevatedButton(
  onPressed: () {},
  child: const Text('Click'),
);

// 级联
final request = HttpRequest()
  ..url = 'https://api.example.com'
  ..headers = {'Content-Type': 'application/json'};
```

### 扩展方法

```dart
// 为 String 添加扩展
extension StringExtension on String {
  bool get isValidEmail => contains('@');

  String capitalize() {
    if (isEmpty) return this;
    return this[0].toUpperCase() + substring(1);
  }
}

// 使用
'email@example.com'.isValidEmail;
'hello'.capitalize(); // 'Hello'
```

## 代码检查

### 运行分析

```bash
fvm dart analyze
```

### 修复建议

```bash
# 自动修复可修复的问题
fvm dart fix --apply
```

### analysis_options.yaml

```yaml
include: package:flutter_lints/flutter.yaml

linter:
  rules:
    # 推荐规则
    - prefer_const_constructors
    - prefer_const_declarations
    - prefer_const_literals_to_create_immutables
    - prefer_final_fields
    - prefer_final_locals
    - avoid_print
    - prefer_single_quotes
    - sort_constructors_first
    - always_declare_return_types
    - avoid_dynamic_type
```
