---
title: Git 提交规范
date: 2025-01-29 00:00:00
permalink: /develop/style/git
categories:
  - 开发
tags:
  - 开发
  - Git
description: 介绍 OneTJ 项目的 Git 提交规范。
---

## 提交消息格式

OneTJ 使用 **Conventional Commits** 格式：

```
<类型>: <描述>

[可选的详细描述]

[关联的 Issue 编号] #<issue-number>
```

### 提交类型

| 类型 | 说明 | 示例 |
|------|------|------|
| `Feat` | 新功能 | `Feat: 添加课程表按周查看功能` |
| `Fix` | 修复 bug | `Fix: 修复令牌刷新失败的问题` |
| `Docs` | 文档更新 | `Docs: 更新 API 配置文档` |
| `Style` | 代码风格调整 | `Style: 统一代码格式` |
| `Refactor` | 代码重构 | `Refactor: 重构 Repository 层` |
| `Perf` | 性能优化 | `Perf: 优化缓存加载性能` |
| `Test` | 测试相关 | `Test: 添加 ViewModel 单元测试` |
| `Chore` | 构建过程或辅助工具变动 | `Chore: 更新依赖版本` |
| `Revert` | 回滚提交 | `Revert: 回滚登录功能更改` |

### 提交示例

```bash
# 简单提交
Feat: 添加登录页面

# 带详细描述的提交
Fix: 修复令牌过期检测

- 修正 TokenData 中的过期计算逻辑
- 添加 30 秒的缓冲时间
- 更新相关单元测试

# 关联 Issue
Feat: 实现课程表功能 #12
```

## 分支管理

### 分支类型

| 分支 | 命名规范 | 说明 |
|------|---------|------|
| **主分支** | `main` | 稳定发布代码 |
| **开发分支** | `develop` | 开发中的代码 |
| **功能分支** | `feature/<功能名>` | 开发新功能 |
| **修复分支** | `fix/<bug描述>` | 修复 bug |
| **热修复分支** | `hotfix/<bug描述>` | 紧急修复已发布版本 |

### 分支命名示例

```bash
# 功能分支
feature/login-page
feature/timetable-view
feature/dark-mode

# 修复分支
fix/token-refresh-error
fix/cache-loading-fail

# 热修复分支
hotfix/crash-on-startup
hotfix/security-patch
```

## 工作流程

### 1. 创建功能分支

```bash
git checkout develop
git pull origin develop
git checkout -b feature/new-feature
```

### 2. 开发并提交

```bash
# 添加文件
git add .

# 提交
git commit -m "Feat: 添加新功能"

# 或使用详细描述
git commit -m "Feat: 添加课程表功能

- 实现课程数据获取
- 实现课程列表展示
- 支持按周次筛选"
```

### 3. 推送并创建 PR

```bash
git push origin feature/new-feature
```

然后在 GitHub 上创建 Pull Request。

### 4. 代码审查

- 至少 1 名团队成员审查
- 所有 CI 检查通过
- 解决所有审查意见

### 5. 合并代码

```bash
# 合并到 develop
git checkout develop
git merge feature/new-feature
git push origin develop
```

### 6. 删除分支

```bash
# 删除本地分支
git branch -d feature/new-feature

# 删除远程分支
git push origin --delete feature/new-feature
```

## Commitizen 工具

### 安装

```bash
# 安装 commitizen
fvm flutter pub global activate commitizen_cli

# 或使用 npm
npm install -g commitizen @commitlint/config-conventional
```

### 使用

```bash
# 使用 cz 代替 git commit
git add .
cz
```

然后按提示选择提交类型、填写描述等。

## Git Hooks

### Husky 配置

```bash
# 安装 husky
npm install -g husky

# 初始化
husky install
husky add .husky/commit-msg 'commitlint --edit $1'
```

### Commitlint 配置

创建 `commitlint.config.js`：

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'Feat',
        'Fix',
        'Docs',
        'Style',
        'Refactor',
        'Perf',
        'Test',
        'Chore',
        'Revert',
      ],
    ],
    'type-case': [2, 'always', 'PascalCase'],
    'type-empty': [2, 'never'],
    'subject-empty': [2, 'never'],
    'subject-max-length': [2, 'always', 100],
  },
};
```

## 常用命令

### 查看提交历史

```bash
# 查看历史
git log

# 查看美化历史
git log --oneline --graph --all

# 查看某文件的修改历史
git log -p lib/main.dart
```

### 修改提交

```bash
# 修改最后一次提交
git commit --amend

# 修改提交消息
git commit --amend -m "新的提交消息"

# 添加遗漏的文件
git add missed_file.dart
git commit --amend --no-edit
```

### 撤销更改

```bash
# 撤销工作区更改
git restore file.dart

# 撤销暂存区更改
git restore --staged file.dart

# 撤销提交（保留更改）
git reset HEAD~1

# 撤销提交（删除更改）
git reset --hard HEAD~1
```

### 变基

```bash
# 变基到最新的 develop
git fetch origin
git rebase origin/develop

# 交互式变基
git rebase -i HEAD~3
```

## 最佳实践

### 提交频率

- 频繁提交，每次提交一个逻辑单元
- 不要一次提交过多更改
- 保持提交原子性

### 提交消息

- 使用中文或英文，保持一致性
- 描述要清晰明了
- 第一行不超过 100 字符

### 分支策略

- 每个功能一个分支
- 分支生命周期要短
- 及时合并和删除

### 代码审查

- 所有代码必须经过审查
- 审查要及时响应
- 保持建设性反馈

## 常见问题

### 提交后发现错误

```bash
# 如果还未推送
git commit --amend

# 如果已推送
git commit -m "Fix: 修正之前的错误"
```

### 合并冲突

```bash
# 拉取最新代码
git pull origin develop

# 手动解决冲突后
git add .
git commit -m "Fix: 解决合并冲突"
```

### 回滚提交

```bash
# 回滚到指定提交（保留更改）
git revert abc123

# 回滚到指定提交（删除更改）
git reset --hard abc123
```
