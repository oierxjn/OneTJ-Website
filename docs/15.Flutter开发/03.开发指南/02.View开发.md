---
title: View 开发指南
date: 2025-01-29 00:00:00
permalink: /develop/guide/view
categories:
  - 开发
tags:
  - 开发
  - View
description: 介绍 OneTJ 项目的 View 开发规范。
---

## View 概述

在 OneTJ 的 MVVM 架构中，View 负责渲染 UI 并响应用户交互，通过监听 ViewModel 的数据变化来更新界面。

## View 结构

### 基本结构

```dart
class MyView extends StatefulWidget {
  const MyView({super.key});

  @override
  State<MyView> createState() => _MyViewState();
}

class _MyViewState extends State<MyView> {
  late final MyViewModel _viewModel;

  @override
  void initState() {
    super.initState();
    _viewModel = MyViewModel();
    _setupStreams();
    _viewModel.loadData();
  }

  void _setupStreams() {
    // 设置 Stream 监听
  }

  @override
  void dispose() {
    _viewModel.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('My View')),
      body: _buildBody(),
    );
  }

  Widget _buildBody() {
    // 构建内容
    return Container();
  }
}
```

## StatefulWidget 生命周期

```dart
class _MyViewState extends State<MyView> {
  late final MyViewModel _viewModel;
  StreamSubscription? _dataSub;
  StreamSubscription? _errorSub;

  @override
  void initState() {
    super.initState();
    _viewModel = MyViewModel();
    _setupStreams();
  }

  void _setupStreams() {
    _dataSub = _viewModel.data.listen((data) {
      if (mounted) {
        setState(() {
          // 更新状态
        });
      }
    });

    _errorSub = _viewModel.errors.listen((error) {
      if (mounted) {
        // 显示错误
      }
    });
  }

  @override
  void dispose() {
    _dataSub?.cancel();
    _errorSub?.cancel();
    _viewModel.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // ...
  }
}
```

## Stream 数据监听

### StreamSubscription

```dart
class _MyViewState extends State<MyView> {
  late MyViewModel _viewModel;
  StreamSubscription<String>? _infoSub;
  String? _studentInfo;

  @override
  void initState() {
    super.initState();
    _viewModel = MyViewModel();

    _infoSub = _viewModel.studentInfo.listen((data) {
      if (mounted) {
        setState(() {
          _studentInfo = data;
        });
      }
    });

    _viewModel.loadStudentInfo();
  }

  @override
  void dispose() {
    _infoSub?.cancel();
    _viewModel.dispose();
    super.dispose();
  }
}
```

### StreamBuilder

```dart
class MyView extends StatelessWidget {
  final MyViewModel _viewModel = MyViewModel();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: StreamBuilder<String>(
        stream: _viewModel.studentInfo,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const CircularProgressIndicator();
          }
          if (snapshot.hasError) {
            return Text('Error: ${snapshot.error}');
          }
          return Text(snapshot.data ?? 'No data');
        },
      ),
    );
  }
}
```

## 加载状态

### 三种状态：加载中、成功、错误

```dart
class _MyViewState extends State<MyView> {
  late MyViewModel _viewModel;
  bool _isLoading = true;
  Object? _error;
  MyData? _data;

  @override
  void initState() {
    super.initState();
    _viewModel = MyViewModel();
    _listenToViewModel();
    _viewModel.loadData();
  }

  void _listenToViewModel() {
    _viewModel.isLoading.listen((loading) {
      if (mounted) {
        setState(() => _isLoading = loading);
      }
    });

    _viewModel.data.listen((data) {
      if (mounted) {
        setState(() => _data = data);
      }
    });

    _viewModel.errors.listen((error) {
      if (mounted) {
        setState(() => _error = error);
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }
    if (_error != null) {
      return Center(child: Text('Error: $_error'));
    }
    if (_data == null) {
      return const Center(child: Text('No data'));
    }
    return _buildContent(_data!);
  }

  Widget _buildContent(MyData data) {
    return Text('Data: $data');
  }
}
```

## UI 事件处理

### 按钮点击

```dart
ElevatedButton(
  onPressed: () {
    _viewModel.handleLogin();
  },
  child: const Text('Login'),
)
```

### 事件监听

```dart
class _MyViewState extends State<MyView> {
  StreamSubscription<UiEvent>? _eventSub;

  @override
  void initState() {
    super.initState();
    _viewModel = MyViewModel();

    _eventSub = _viewModel.events.listen((event) {
      if (!mounted) return;

      if (event is NavigateEvent) {
        context.go(event.path);
      } else if (event is ShowSnackBarEvent) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(event.message)),
        );
      }
    });
  }

  @override
  void dispose() {
    _eventSub?.cancel();
    super.dispose();
  }
}
```

## 常用 UI 组件

### 列表

```dart
ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) {
    final item = items[index];
    return ListTile(
      title: Text(item.title),
      subtitle: Text(item.subtitle),
    );
  },
)
```

### 卡片

```dart
Card(
  margin: const EdgeInsets.all(8),
  child: Padding(
    padding: const EdgeInsets.all(16),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Title',
          style: Theme.of(context).textTheme.titleMedium,
        ),
        const SizedBox(height: 8),
        Text('Content'),
      ],
    ),
  ),
)
```

### 输入框

```dart
TextField(
  decoration: const InputDecoration(
    labelText: '用户名',
    border: OutlineInputBorder(),
  ),
  onChanged: (value) {
    _viewModel.updateUsername(value);
  },
)
```

### 选择器

```dart
DropdownButton<String>(
  value: selectedValue,
  items: const [
    DropdownMenuItem(value: 'option1', child: Text('选项1')),
    DropdownMenuItem(value: 'option2', child: Text('选项2')),
  ],
  onChanged: (value) {
    if (value != null) {
      _viewModel.selectOption(value);
    }
  },
)
```

## 布局技巧

### 响应式布局

```dart
LayoutBuilder(
  builder: (context, constraints) {
    if (constraints.maxWidth > 600) {
      return _buildWideLayout();
    }
    return _buildNarrowLayout();
  },
)
```

### 可滚动内容

```dart
SingleChildScrollView(
  padding: const EdgeInsets.all(16),
  child: Column(
    children: [
      // 内容...
    ],
  ),
)
```

### 居中内容

```dart
Center(
  child: Column(
    mainAxisAlignment: MainAxisAlignment.center,
    children: [
      Icon(Icons.check, size: 64),
      SizedBox(height: 16),
      Text('Success'),
    ],
  ),
)
```

## 最佳实践

### 1. 使用 const 构造函数

```dart
const Text('Hello')
const SizedBox(height: 16)
const Icon(Icons.home)
```

### 2. 提取 Widget

```dart
// 好
class StudentInfoCard extends StatelessWidget {
  final StudentInfo info;
  const StudentInfoCard({super.key, required this.info});

  @override
  Widget build(BuildContext context) {
    return Card(...);
  }
}

// 使用
StudentInfoCard(info: studentInfo)

// 不好
buildStudentCard(StudentInfo info) {
  return Card(...);
}
```

### 3. 使用主题颜色

```dart
Container(
  color: Theme.of(context).colorScheme.primary,
  child: Text(
    'Hello',
    style: TextStyle(
      color: Theme.of(context).colorScheme.onPrimary,
    ),
  ),
)
```

### 4. 检查 mounted 状态

```dart
setState(() {
  // 确保 widget 还在树中
});

if (mounted) {
  setState(() { });
}

_stream.listen((data) {
  if (mounted) {
    setState(() { });
  }
});
```

### 5. 及时取消订阅

```dart
@override
void dispose() {
  _subscription1?.cancel();
  _subscription2?.cancel();
  _viewModel.dispose();
  super.dispose();
}
```

## 示例：完整的 View

```dart
class DashboardView extends StatefulWidget {
  const DashboardView({super.key});

  @override
  State<DashboardView> createState() => _DashboardViewState();
}

class _DashboardViewState extends State<DashboardView> {
  late final HomeViewModel _viewModel;
  StreamSubscription<String>? _infoSub;
  StreamSubscription<SchoolCalendarData>? _calendarSub;
  StreamSubscription<Object>? _studentErrorSub;
  StreamSubscription<Object>? _calendarErrorSub;

  String? _studentInfo;
  SchoolCalendarData? _calendar;
  Object? _studentError;
  Object? _calendarError;
  bool _studentLoading = true;
  bool _calendarLoading = true;

  @override
  void initState() {
    super.initState();
    _viewModel = HomeViewModel();

    _infoSub = _viewModel.studentInfo.listen((data) {
      if (mounted) {
        setState(() {
          _studentInfo = data;
          _studentError = null;
          _studentLoading = false;
        });
      }
    });

    _calendarSub = _viewModel.schoolCalendar.listen((data) {
      if (mounted) {
        setState(() {
          _calendar = data;
          _calendarError = null;
          _calendarLoading = false;
        });
      }
    });

    _studentErrorSub = _viewModel.studentErrors.listen((error) {
      if (mounted) {
        setState(() {
          _studentError = error;
          _studentLoading = false;
        });
      }
    });

    _calendarErrorSub = _viewModel.calendarErrors.listen((error) {
      if (mounted) {
        setState(() {
          _calendarError = error;
          _calendarLoading = false;
        });
      }
    });

    _viewModel.loadStudentInfo();
    _viewModel.loadSchoolCalendar();
  }

  @override
  void dispose() {
    _infoSub?.cancel();
    _calendarSub?.cancel();
    _studentErrorSub?.cancel();
    _calendarErrorSub?.cancel();
    _viewModel.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildStudentInfo(),
          const SizedBox(height: 24),
          _buildCalendar(),
        ],
      ),
    );
  }

  Widget _buildStudentInfo() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text('Student Info', style: TextStyle(fontWeight: FontWeight.bold)),
        const SizedBox(height: 8),
        if (_studentLoading)
          const LinearProgressIndicator()
        else if (_studentError != null)
          Text('Failed: $_studentError')
        else
          Text(_studentInfo ?? 'No data'),
      ],
    );
  }

  Widget _buildCalendar() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text('Calendar', style: TextStyle(fontWeight: FontWeight.bold)),
        const SizedBox(height: 8),
        if (_calendarLoading)
          const LinearProgressIndicator()
        else if (_calendarError != null)
          Text('Failed: $_calendarError')
        else if (_calendar == null)
          const Text('No data')
        else
          Text('Week: ${_calendar!.week}'),
      ],
    );
  }
}
```
