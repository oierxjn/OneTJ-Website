---
title: OAuth 配置
date: 2025-01-29 00:00:00
permalink: /reference/config/oauth
categories:
  - 配置
tags:
  - 配置
  - OAuth
  - API
description: 介绍 OneTJ 的 OAuth2 认证配置。
---

## OAuth2 概述

OneTJ 使用同济大学官方 Keycloak 系统进行 OAuth2 认证，采用**授权码模式**（Authorization Code Flow）。

## 配置常量

配置位于 `lib/app/constant/site_constant.dart`：

```dart
// API 基础 URL
const String tongjiApiBaseUrl = "api.tongji.edu.cn";

// OAuth 客户端配置
const String tongjiClientID = "authorization-xxb-onedottongji-yuchen";
const String oneTJredirectUri = "https://fakeredir.jkljkluiouio.top";

// API 端点
const String loginEndpointPath = "/keycloak/realms/OpenPlatform/protocol/openid-connect/auth";
const String code2tokenPath = "/v1/token";

// OAuth 权限范围
const List<String> oauthScope = [
  "dc_user_student_info",
  "rt_onetongji_cet_score",
  "rt_onetongji_school_calendar_current_term_calendar",
  "rt_onetongji_undergraduate_score",
  "rt_teaching_info_undergraduate_summarized_grades",
  "rt_onetongji_student_timetable",
  "rt_teaching_info_sports_test_data",
  "rt_teaching_info_sports_test_health",
  "rt_onetongji_manual_arrange",
  "rt_onetongji_school_calendar_all_term_calendar",
  "rt_onetongji_msg_list",
  "rt_onetongji_msg_detail",
];
```

## 配置说明

### Client ID

客户端标识符，用于识别应用。

```dart
const String tongjiClientID = "authorization-xxb-onedottongji-yuchen";
```

### Redirect URI

授权完成后的重定向地址，必须是已注册的合法 URI。

```dart
const String oneTJredirectUri = "https://fakeredir.jkljkluiouio.top";
```

::: warning 重要

重定向 URI 需要在同济大学开放平台注册白名单，否则授权会被拒绝。

:::

### Scope 权限范围

定义应用请求的访问权限。

| Scope | 说明 |
|-------|------|
| `dc_user_student_info` | 学生基本信息 |
| `rt_onetongji_cet_score` | CET 成绩 |
| `rt_onetongji_school_calendar_current_term_calendar` | 当前学期校历 |
| `rt_onetongji_undergraduate_score` | 本科生成绩 |
| `rt_onetongji_student_timetable` | 学生课程表 |
| `rt_teaching_info_sports_test_data` | 体测数据 |
| `rt_teaching_info_sports_test_health` | 体测健康数据 |
| `rt_onetongji_manual_arrange` | 手动安排 |
| `rt_onetongji_school_calendar_all_term_calendar` | 全部学期校历 |
| `rt_onetongji_msg_list` | 消息列表 |
| `rt_onetongji_msg_detail` | 消息详情 |

## OAuth2 流程

### 1. 构建授权 URL

```dart
Uri buildAuthUri() {
  return Uri.https(
    tongjiApiBaseUrl,
    loginEndpointPath,
    {
      'client_id': tongjiClientID,
      'redirect_uri': oneTJredirectUri,
      'response_type': 'code',
      'scope': oauthScope.join(' '),
    },
  );
}
```

### 2. 用户授权

用户在 WebView 中完成登录和授权。

### 3. 获取授权码

授权成功后，重定向到 `redirect_uri?code=xxx`。

### 4. 交换令牌

```dart
Future<void> code2token(String code) async {
  final uri = Uri.https(tongjiApiBaseUrl, code2tokenPath);
  final response = await http.Post(
    uri,
    body: {
      'grant_type': 'authorization_code',
      'client_id': tongjiClientID,
      'code': code,
      'redirect_uri': oneTJredirectUri,
    },
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
  );
  // 处理响应...
}
```

### 5. 获取响应

```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJSUzI1NiIs...",
  "expires_in": 3600,
  "refresh_expires_in": 2592000,
  "token_type": "Bearer"
}
```

## 令牌管理

### Token 数据结构

```dart
class TokenData {
  final String accessToken;
  final String refreshToken;
  final int expiresIn;        // Access Token 有效期（秒）
  final int refreshExpiresIn; // Refresh Token 有效期（秒）
  final DateTime issuedAt;    // 颁发时间
}
```

### 令牌过期检查

```dart
bool isAccessTokenExpired({Duration skew = Duration.zero}) {
  final expiryTime = issuedAt.add(Duration(seconds: expiresIn));
  return DateTime.now().isAfter(expiryTime.subtract(skew));
}

bool isRefreshTokenExpired({Duration skew = Duration.zero}) {
  final expiryTime = issuedAt.add(Duration(seconds: refreshExpiresIn));
  return DateTime.now().isAfter(expiryTime.subtract(skew));
}
```

### 令牌自动刷新

```dart
Future<String> _getValidAccessToken() async {
  final repo = TokenRepository.getInstance();
  final token = await repo.getToken();

  if (token == null) {
    throw AppException('AUTH_REQUIRED', 'Missing access token');
  }

  // Access Token 未过期
  if (!token.isAccessTokenExpired(skew: _tokenSkew)) {
    return token.accessToken;
  }

  // Refresh Token 已过期
  if (token.isRefreshTokenExpired(skew: _tokenSkew)) {
    throw AppException('AUTH_EXPIRED', 'Refresh token expired');
  }

  // 自动刷新
  final refreshed = await refreshToken(token.refreshToken);
  await repo.saveFromCode2Token(refreshed);
  return refreshed.accessToken;
}
```

## API 调用

### 授权请求头

```dart
Future<http.Response> _authorizedGet(Uri uri) async {
  final accessToken = await _getValidAccessToken();
  return await http.get(
    uri,
    headers: {
      'Authorization': 'Bearer $accessToken',
    },
  );
}
```

## 配置修改

### 更新 Client ID

如果获得了新的 Client ID：

```dart
const String tongjiClientID = "your-new-client-id";
```

### 更新 Redirect URI

如果获得了新的重定向 URI：

```dart
const String oneTJredirectUri = "https://your-new-redirect-uri.com";
```

### 添加新 Scope

```dart
const List<String> oauthScope = [
  // 现有 scopes...
  "new_scope_name",  // 添加新权限
];
```

::: warning 注意

修改 OAuth 配置后，需要重新获取用户授权。

:::
